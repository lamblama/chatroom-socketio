<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <link rel="shortcut icon" href="images/favicon.ico"/>
  <title>聊天室</title>
  <link rel="Bookmark" href="images/favicon.ico" />
  <link rel="shortcut icon" href="images/favicon.ico" />
  <link rel="icon" href="images/favicon.ico" />
 
  
  <link rel="stylesheet" href="css/index.css" />
  <style>
    .register_box {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 380px;
      height: 380px;
      transform: translate(-50%, -50%);
      border-radius: 4px;
      background-color: #fff;
      box-shadow: #999 0 2px 10px;
    }

    .register_box h3 {
      text-align: center;
      color: #333;
      font-size: 24px;
      font-weight: 400;
      margin: 15px auto;
    }

    .input {
      border: 1px solid #ccc;
      padding: 7px 0px;
      padding-left: 0px;
      border-radius: 3px;
      padding-left: 5px;
      -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
      box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
      -webkit-transition: border-color ease-in-out 0.15s, -webkit-box-shadow ease-in-out 0.15s;
      -o-transition: border-color ease-in-out 0.15s, box-shadow ease-in-out 0.15s;
      transition: border-color ease-in-out 0.15s, box-shadow ease-in-out 0.15s;
      width: 200px;
    }

    .register_box>div {
      display: flex;
      margin-bottom: 15px;
    }

    .register_box div>div {
      display: inline-block;
      margin: 0 20px;
    }

    #register_avatar {
      width: 250px;
    }

    #register_avatar li {
      width: 46px;
      height: 46px;
      display: inline-block;
    }

    #register_avatar li img {
      width: 44px;
      height: 44px;
      margin: 2px;
    }

    .button {
      text-align: center;
    }

    .button #register {
      position: relative;
      display: inline-block;
      width: 200px;
      box-sizing: border-box;
      font-size: 14px;
      text-align: center;
      text-decoration: none;
      color: #ffffff;
      line-height: 2.55555556;
      border-radius: 5px;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
      overflow: hidden;
      background-color: #66afe9;
      border: none;
      cursor: pointer;
      margin-top: 5px;
    }

    .button #register_login {
      position: relative;
      display: inline-block;
      box-sizing: border-box;
      font-size: 14px;
      text-align: center;
      text-decoration: none;
      color: #ffffff;
      line-height: 2.55555556;
      border-radius: 5px;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
      overflow: hidden;
      border: none;
      cursor: pointer;
      margin-top: 5px;
      width: 50px;
      background-color: #cccccc;
      margin-right: -25px;
    }

    .register_box li.now img {
      border: 2px solid #1aad19;
    }

    .login_box {
      height: 300px;
    }

    .login_box h3 {
      line-height: 80px;
    }

    .login_box input {
      width: 250px;
      border: 1px solid #ccc;
    }

    .login_box p {
      padding-left: 60px;
    }

    .login_box div {
      text-align: center;
      margin-top: 15px;
    }

    .weui-btn {
      display: inline-block;
      width: 200px;
    }

    #loginBtn {
      background: #66AFE9;
    }

    #registerBtn {
      width: 50px;
      background: #CCCCCC;
      margin-left: 10px;
    }

    /* ========== 新增私聊相关样式 ========== */
    /* 私聊按钮样式 */
    .private-chat-btn {
      font-size: 12px;
      padding: 2px 5px;
      margin-left: 10px;
      background-color: #66afe9;
      color: #fff;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    /* 切换群聊按钮 */
    .switch-group-btn {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 240px;
      padding: 5px 0;
      background-color: #1aad19;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    /* 聊天标题样式优化 */
    .chat-title {
      position: relative;
    }
    .chat-type-tag {
      font-size: 12px;
      color: #666;
      margin-left: 10px;
    }
  </style>
</head>

<body>
  <!-- 注册部分 -->
  <div class="register_box" style="display: none;">
    <h3>用户注册</h3>
    <div>
      <div>用户</div>
      <input class="input" type="text" placeholder="登陆账号" id="register_username"><br>
    </div>
    <div>
      <div>密码</div>
      <input class="input" type="text" placeholder="登陆密码" id="register_password"><br>
    </div>
    <div id="sex">
      <div>性别</div>
      男&nbsp; <input type="radio" value="male" name="sex"> &nbsp; &nbsp;
      女&nbsp; <input type="radio" value="female" name="sex">
    </div>
    <div>
      <div>头像</div>
      <ul id="register_avatar">
        <li class="now"><img src="images/avatar01.jpg" alt="" /></li>
        <li><img src="images/avatar02.jpg" alt="" /></li>
        <li><img src="images/avatar03.jpg" alt="" /></li>
        <li><img src="images/avatar04.jpg" alt="" /></li>
        <li><img src="images/avatar05.jpg" alt="" /></li>
        <li><img src="images/avatar06.jpg" alt="" /></li>
        <li><img src="images/avatar07.jpg" alt="" /></li>
        <li><img src="images/avatar08.jpg" alt="" /></li>
        <li><img src="images/avatar09.jpg" alt="" /></li>
        <li><img src="images/avatar10.jpg" alt="" /></li>
      </ul>
    </div>
    <section class="button">
      <input type="button" value="注册" id="register"> &nbsp;
      <button id="register_login">登录</button>
    </section>
  </div>


  <!-- 登陆部分 -->
  <div class="login_box" style="display: block;">
    <h3>用户登录</h3>
    <p>用户名</p>
    <input type="text" placeholder="请输入用户名" id="username" />
    <p>密码</p>
    <input type="password" placeholder="请输入密码" id="password" />
    <div>
      <button class="weui-btn" id="loginBtn">登录</button>
      <button class="weui-btn" id="registerBtn">注册</button>
    </div>
  </div>


  <!-- 聊天室部分 -->
  <div class="container" style="display: none;">
    <!-- 用户列表 -->
    <div class="user-list">
      <div class="header">
        <div class="avatar">
          <img class="img avatar_url" src="images/avatar2.jpg" alt="" />
        </div>
        <div class="info">
          <h3 class="username">cy</h3>
        </div>
      </div>
      <div class="title">
        <h3>用户列表</h3>
      </div>
      <ul id="userList">
        <!-- 在线用户列表动态生成 -->
      </ul>
      <!-- 新增：切换回群聊按钮 -->
      <button class="switch-group-btn" id="switchGroupBtn" style="display: none;">切换到群聊</button>
    </div>
    <!-- 聊天主窗口 -->
    <div class="box">
      <!-- 聊天窗口头部 -->
      <div class="box-hd">
        <h3 class="chat-title">聊天室(<span id="userCount">99</span>) <span class="chat-type-tag">群聊</span></h3>
      </div>

      <!-- 聊天窗口主体区域 -->
      <div class="box-bd" id="messageBox">
        <!-- 消息列表动态生成 -->
      </div>

      <!-- 聊天窗口底部区域 -->
      <div class="box-ft">
        <!-- 工具栏 -->
        <div class="toolbar">
          
          <a href="javascript:;" title="截屏" class="screen-cut" id="screenCutBtn"></a>
          <a href="javascript:;" title="图片" class="file">
            <label for="file"></label>
            <input type="file" id="file" style="display: none;">
          </a>
        </div>
        
        <!-- 内容输入区域 -->
        <div class="content">
          <div class="text" id="content" contenteditable></div>
        </div>
        <!-- 发送按钮 -->
        <div class="action">
          <span class="desc">按下Ctrl+Enter发送</span>
          <a class="btn-send" id="btn-send" href="javascript:;">发送</a>
        </div>
      </div>
    </div>
  </div>

  <!-- 引入依赖 -->
  <script src="/socket.io/socket.io.js"></script>
  <script src="js/jquery-1.12.4.js"></script>
  <script src="lib/jquery-mCustomScrollbar/script/jquery.mCustomScrollbar.min.js"></script>
 
  
  <!-- 引入html2canvas，用于前端截图 -->
<script src="https://cdn.bootcdn.net/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // ========== 全局变量 ==========
    const socket = io();
    let myUsername = ''; // 当前登录用户名
    let myAvatar = '';   // 当前登录用户头像
    let currentChatType = 'group'; // 当前聊天类型：group(群聊)/private(私聊)
    let currentPrivateTarget = ''; // 当前私聊对象

    // ========== DOM元素 ==========
    // 登录/注册
    const $loginBox = $('.login_box');
    const $registerBox = $('.register_box');
    const $username = $('#username');
    const $password = $('#password');
    const $loginBtn = $('#loginBtn');
    const $registerBtn = $('#registerBtn');
    const $registerUsername = $('#register_username');
    const $registerPassword = $('#register_password');
    const $register = $('#register');
    const $registerLogin = $('#register_login');
    const $registerAvatar = $('#register_avatar li');
    // 聊天室
    const $container = $('.container');
    const $avatarUrl = $('.avatar_url');
    const $usernameEle = $('.username');
    const $userList = $('#userList');
    const $userCount = $('#userCount');
    const $messageBox = $('#messageBox');
    const $content = $('#content');
    const $btnSend = $('#btn-send');
    const $file = $('#file');
    const $screenCutBtn = $('#screenCutBtn');
    const $chatTitle = $('.chat-title');
    const $switchGroupBtn = $('#switchGroupBtn');

   

    // ========== 登录/注册逻辑 ==========
    // 登录按钮
    $loginBtn.click(function() {
      const username = $username.val().trim();
      const password = $password.val().trim();
      if (!username || !password) {
        alert('用户名或密码不能为空！');
        return;
      }
      // 验证登录
      socket.emit('checkoutLogin', { username, password });
      socket.once('checkoutAnswer', (data) => {
        if (data.msg === '用户密码正确') {
          myUsername = username;
          myAvatar = data.avatar || 'images/avatar01.jpg';
          // 发送登录请求
          socket.emit('login', { username, avatar: myAvatar });
          socket.once('loginSuccess', () => {
            $loginBox.hide();
            $container.show();
            $avatarUrl.attr('src', myAvatar);
            $usernameEle.text(myUsername);
          });
          socket.once('loginError', () => {
            alert('登录失败，用户名已在线！');
          });
        } else {
          alert(data.msg);
        }
      });
    });

    // 切换到注册
    $registerBtn.click(function() {
      $loginBox.hide();
      $registerBox.show();
    });

    // 注册页面切换到登录
    $registerLogin.click(function() {
      $registerBox.hide();
      $loginBox.show();
    });

    // 注册按钮
    $register.click(function() {
      const username = $registerUsername.val().trim();
      const password = $registerPassword.val().trim();
      if (!username || !password) {
        alert('用户名或密码不能为空！');
        return;
      }
      const avatar = $registerAvatar.filter('.now').find('img').attr('src');
      // 发送注册请求
      socket.emit('registerUser', {
        username,
        password,
        avatar
      });
      socket.once('registerSuccess', () => {
        alert('注册成功，请登录！');
        $registerBox.hide();
        $loginBox.show();
        $username.val(username);
        $password.val('');
      });
      socket.once('registerError', () => {
        alert('用户名已被注册！');
      });
    });

    // ========== 在线用户列表 ==========
    socket.on('userList', (users) => {
      $userList.empty();
      $userCount.text(users.length);
      users.forEach(user => {
        if (user.username === myUsername) return; // 不显示自己
        const $li = $(`
          <li class="user">
            <div class="avatar"><img src="${user.avatar}" alt="" /></div>
            <div class="name">${user.username} 
              <button class="private-chat-btn" data-username="${user.username}">私聊</button>
            </div>
          </li>
        `);
        $userList.append($li);
        // 绑定私聊按钮事件
        $li.find('.private-chat-btn').click(function() {
          currentChatType = 'private';
          currentPrivateTarget = $(this).data('username');
          // 更新聊天标题
          $chatTitle.html(`与 ${currentPrivateTarget} 的私聊 <span class="chat-type-tag">私聊</span>`);
          // 显示切换群聊按钮
          $switchGroupBtn.show();
          // 清空消息框，加载私聊历史
          $messageBox.empty();
          socket.emit('privateChatInit', { fromUser: myUsername, toUser: currentPrivateTarget });
        });
      });
    });

    // ========== 切换回群聊 ==========
    $switchGroupBtn.click(function() {
      currentChatType = 'group';
      currentPrivateTarget = '';
      // 更新聊天标题
      $chatTitle.html(`聊天室(<span id="userCount">${$userCount.text()}</span>) <span class="chat-type-tag">群聊</span>`);
      // 隐藏切换按钮
      $switchGroupBtn.hide();
      // 清空消息框，加载群聊历史
      $messageBox.empty();
      socket.emit('switchToGroupChat');
    });

    // ========== 发送消息 ==========
    // 发送按钮
    $btnSend.click(sendMessage);
    // 快捷键 Ctrl+Enter 发送
    $(document).keydown(function(e) {
      if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    });

    // 发送消息核心逻辑
    function sendMessage() {
      const content = $content.html().trim();
      if (!content) return;
      // 区分群聊/私聊
      if (currentChatType === 'group') {
        // 发送群聊消息
        socket.emit('sendMessage', {
          username: myUsername,
          content: content,
          avatar: myAvatar,
          type: 'text'
        });
      } else {
        // 发送私聊消息
        socket.emit('sendPrivateMsg', {
          fromUser: myUsername,
          toUser: currentPrivateTarget,
          content: content,
          avatar: myAvatar
        });
      }
      // 清空输入框
      $content.html('');
    }

    // ========== 发送图片 ==========
    $file.change(function() {
      const file = this.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const imgBase64 = e.target.result;
        if (currentChatType === 'group') {
          // 群聊图片
          socket.emit('sendImage', {
            username: myUsername,
            img: imgBase64,
            avatar: myAvatar,
            type: 'image'
          });
        } else {
          // 私聊图片
          socket.emit('sendPrivateImage', {
            fromUser: myUsername,
            toUser: currentPrivateTarget,
            img: imgBase64,
            avatar: myAvatar
          });
        }
      };
      reader.readAsDataURL(file);
      $(this).val(''); // 清空文件选择
    });

    // 恢复截图功能（改用前端html2canvas截图，彻底解决登录态问题）
$screenCutBtn.click(function() {
  // 1. 提示用户等待（截图需要一点时间）
  alert('正在截图，请稍等...');
  
  // 2. 使用html2canvas截取当前页面的全部内容
  html2canvas(document.body, {
    useCORS: true,        // 解决跨域图片（比如头像）无法截图的问题
    allowTaint: true,     // 允许跨域图片
    scale: 1,             // 截图清晰度
    logging: false        // 关闭控制台日志
  }).then(canvas => {
    // 3. 将截图转成base64编码（前端直接拿到当前页面的截图）
    const imgBase64 = canvas.toDataURL('image/png');
    
    // 4. 发送base64截图给后端保存（不再传URL，彻底避免登录态问题）
    socket.emit('webshotByBase64', {
      base64: imgBase64,
      username: myUsername,
      avatar: myAvatar
    });

    // 5. 监听截图结果
    socket.once('webshotSuccess', () => {
      alert('截图成功，已发送到群聊！');
    });
    socket.once('webshotError', (data) => {
      alert('截图失败：' + data.msg);
    });
  }).catch(err => {
    alert('截图失败：' + err.message);
  });
});

    // ========== 接收消息 ==========
    // 接收群聊文本消息
    socket.on('receiveMessage', (msg) => {
      if (currentChatType !== 'group') return; // 私聊时不显示群聊消息
      renderMessage(msg);
    });

    // 接收群聊图片消息
    socket.on('receiveImage', (msg) => {
      if (currentChatType !== 'group') return;
      renderImageMessage(msg);
    });

    // 接收私聊文本消息
    socket.on('receivePrivateMsg', (msg) => {
      // 只显示当前私聊对象的消息
      if (currentChatType !== 'private' || 
          (msg.from_user !== currentPrivateTarget && msg.to_user !== currentPrivateTarget)) {
        return;
      }
      renderPrivateMessage(msg);
    });

    // 接收私聊图片消息
    socket.on('receivePrivateImage', (msg) => {
      if (currentChatType !== 'private' || 
          (msg.from_user !== currentPrivateTarget && msg.to_user !== currentPrivateTarget)) {
        return;
      }
      renderPrivateImageMessage(msg);
    });

    // 加载私聊历史
    socket.on('privateHistory', (data) => {
      currentPrivateTarget = data.toUser;
      data.msgs.forEach(msg => {
        if (msg.type === 'text') {
          renderPrivateMessage(msg);
        } else {
          renderPrivateImageMessage(msg);
        }
      });
    });

    // ========== 系统消息（用户加入/离开） ==========
    socket.on('addUser', (user) => {
      if (currentChatType !== 'group') return;
      const $systemMsg = $(`
        <div class="system">
          <p class="message_system">
            <span class="content">${user.username} 加入了聊天室</span>
          </p>
        </div>
      `);
      $messageBox.append($systemMsg);
      scrollToBottom();
    });

    socket.on('deleteUser', (user) => {
      if (currentChatType !== 'group') return;
      const $systemMsg = $(`
        <div class="system">
          <p class="message_system">
            <span class="content">${user.username} 离开了聊天室</span>
          </p>
        </div>
      `);
      $messageBox.append($systemMsg);
      scrollToBottom();
    });

    // ========== 渲染消息 ==========
    // 渲染群聊文本消息
    function renderMessage(msg) {
      const isMy = msg.username === myUsername;
      const $msg = $(`
        <div class="message-box">
          <div class="${isMy ? 'my' : 'other'} message">
            <img class="avatar" src="${msg.avatar}" alt="" />
            <div class="content">
              <div style="margin-bottom: 3px;margin-right: 3px;">${msg.time}</div>
              ${!isMy ? `<div class="nickname">${msg.username}</div>` : ''}
              <div class="bubble">
                <div class="bubble_cont">${msg.content}</div>
              </div>
            </div>
          </div>
        </div>
      `);
      $messageBox.append($msg);
      scrollToBottom();
    }

    // 渲染群聊图片消息
    function renderImageMessage(msg) {
      const isMy = msg.username === myUsername;
      const $msg = $(`
        <div class="message-box">
          <div class="${isMy ? 'my' : 'other'} message">
            <img class="avatar" src="${msg.avatar}" alt="" />
            <div class="content">
              <div style="margin-bottom: 3px;margin-right: 3px;">${msg.time}</div>
              ${!isMy ? `<div class="nickname">${msg.username}</div>` : ''}
              <div class="bubble">
                <div class="bubble_cont"><img src="${msg.content}" alt="图片" style="max-width:350px;max-height:240px;"></div>
              </div>
            </div>
          </div>
        </div>
      `);
      $messageBox.append($msg);
      scrollToBottom();
    }

    // 渲染私聊文本消息
    function renderPrivateMessage(msg) {
      const isMy = msg.from_user === myUsername;
      const $msg = $(`
        <div class="message-box">
          <div class="${isMy ? 'my' : 'other'} message">
            <img class="avatar" src="${msg.avatar}" alt="" />
            <div class="content">
              <div style="margin-bottom: 3px;margin-right: 3px;">${msg.time}</div>
              ${!isMy ? `<div class="nickname">${msg.from_user}</div>` : ''}
              <div class="bubble">
                <div class="bubble_cont">${msg.content}</div>
              </div>
            </div>
          </div>
        </div>
      `);
      $messageBox.append($msg);
      scrollToBottom();
    }

    // 渲染私聊图片消息
    function renderPrivateImageMessage(msg) {
      const isMy = msg.from_user === myUsername;
      const $msg = $(`
        <div class="message-box">
          <div class="${isMy ? 'my' : 'other'} message">
            <img class="avatar" src="${msg.avatar}" alt="" />
            <div class="content">
              <div style="margin-bottom: 3px;margin-right: 3px;">${msg.time}</div>
              ${!isMy ? `<div class="nickname">${msg.from_user}</div>` : ''}
              <div class="bubble">
                <div class="bubble_cont"><img src="${msg.content}" alt="图片" style="max-width:350px;max-height:240px;"></div>
              </div>
            </div>
          </div>
        </div>
      `);
      $messageBox.append($msg);
      scrollToBottom();
    }

    // 强制监听私聊消息（确保在页面加载后执行）
// 监听私聊消息接收事件（receivePrivateMsg）
socket.on('receivePrivateMsg', function(msg) {
    // 1. 先在控制台打印消息，确认是否收到（调试用）
    console.log('监听到私聊消息：', msg);

    // 2. 校验：只有当前处于私聊状态，且是当前私聊对象的消息才渲染
    if (currentChatType !== 'private') return;
    if (msg.from_user !== currentPrivateTarget && msg.to_user !== currentPrivateTarget) return;

    // 3. 判断消息是自己发的还是对方发的
    const isMyMsg = msg.from_user === myUsername;
    
    // 4. 拼接消息HTML（完全匹配你的页面样式）
    const msgHtml = `
        <div class="message-box">
            <div class="${isMyMsg ? 'my' : 'other'} message">
                <img class="avatar" src="${msg.avatar}" alt="${msg.from_user}" />
                <div class="content">
                    <div style="margin-bottom: 3px;">${msg.time}</div>
                    ${!isMyMsg ? `<div class="nickname">${msg.from_user}</div>` : ''}
                    <div class="bubble">
                        <div class="bubble_cont">${msg.content}</div>
                    </div>
                </div>
            </div>
        </div>
    `;

    // 5. 把消息添加到聊天窗口，并滚动到底部
    $('#messageBox').append(msgHtml);
    $('#messageBox').scrollTop($('#messageBox')[0].scrollHeight);
});

   

  </script>
</body>

</html>